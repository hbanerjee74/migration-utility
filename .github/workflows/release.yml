name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 1.0.0)'
        required: true
        type: string

jobs:
  build:
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact-name: release-macos
          - os: windows-latest
            artifact-name: release-windows
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: npm
          cache-dependency-path: |
            app/package-lock.json
            app/sidecar/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: app/src-tauri -> target

      - name: Install npm dependencies
        working-directory: app
        run: npm ci

      - name: Install sidecar dependencies
        working-directory: app/sidecar
        run: npm ci

      - name: Build sidecar
        working-directory: app/sidecar
        run: node build.js

      - name: Stamp version into config files
        working-directory: app
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.version }}
        run: |
          # Tauri config only accepts X.Y.Z — strip any pre-release suffix (e.g. 1.0.0-rc1 → 1.0.0)
          TAURI_VERSION="${RELEASE_VERSION%%-*}"
          export TAURI_VERSION
          node -e "const fs=require('fs'); const f='src-tauri/tauri.conf.json'; const c=JSON.parse(fs.readFileSync(f,'utf8')); c.version=process.env.TAURI_VERSION; fs.writeFileSync(f,JSON.stringify(c,null,2)+'\n');"
          node -e "const fs=require('fs'); const f='package.json'; const c=JSON.parse(fs.readFileSync(f,'utf8')); c.version=process.env.RELEASE_VERSION; fs.writeFileSync(f,JSON.stringify(c,null,2)+'\n');"
          sed -i.bak "s/^version = \".*\"/version = \"${RELEASE_VERSION}\"/" src-tauri/Cargo.toml && rm -f src-tauri/Cargo.toml.bak

      - name: Cache bundled Node.js binary
        id: node-cache
        uses: actions/cache@v4
        with:
          path: app/src-tauri/resources/node
          key: bundled-node-v22.14.0-${{ matrix.os }}

      - name: Bundle Node.js 22 LTS binary (macOS)
        if: matrix.os == 'macos-latest' && steps.node-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          NODE_VERSION="v22.14.0"
          RUNNER_ARCH="$(uname -m)"
          if [ "$RUNNER_ARCH" = "arm64" ]; then
            NODE_ARCH="darwin-arm64"
          else
            NODE_ARCH="darwin-x64"
          fi
          DEST="app/src-tauri/resources/node/${NODE_ARCH}/bin"
          mkdir -p "$DEST"
          TARBALL="node-${NODE_VERSION}-${NODE_ARCH}.tar.gz"
          URL="https://nodejs.org/dist/${NODE_VERSION}/${TARBALL}"
          echo "Downloading Node.js ${NODE_VERSION} for ${NODE_ARCH}..."
          curl -fsSL "$URL" -o "/tmp/${TARBALL}"
          curl -fsSL "https://nodejs.org/dist/${NODE_VERSION}/SHASUMS256.txt" -o "/tmp/SHASUMS256.txt"
          (cd /tmp && grep "${TARBALL}" SHASUMS256.txt | shasum -a 256 -c -)
          tar -xzf "/tmp/${TARBALL}" -C /tmp "node-${NODE_VERSION}-${NODE_ARCH}/bin/node"
          mv "/tmp/node-${NODE_VERSION}-${NODE_ARCH}/bin/node" "${DEST}/node"
          chmod +x "${DEST}/node"
          "${DEST}/node" --version
          rm -rf "/tmp/${TARBALL}" "/tmp/node-${NODE_VERSION}-${NODE_ARCH}"

      - name: Bundle Node.js 22 LTS binary (Windows)
        if: matrix.os == 'windows-latest' && steps.node-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          set -euo pipefail
          NODE_VERSION="v22.14.0"
          NODE_ARCH="win-x64"
          DEST="app/src-tauri/resources/node/${NODE_ARCH}/bin"
          mkdir -p "$DEST"
          ZIPFILE="node-${NODE_VERSION}-${NODE_ARCH}.zip"
          URL="https://nodejs.org/dist/${NODE_VERSION}/${ZIPFILE}"
          echo "Downloading Node.js ${NODE_VERSION} for ${NODE_ARCH}..."
          curl -fsSL "$URL" -o "/tmp/${ZIPFILE}"
          curl -fsSL "https://nodejs.org/dist/${NODE_VERSION}/SHASUMS256.txt" -o "/tmp/SHASUMS256.txt"
          (cd /tmp && grep "${ZIPFILE}" SHASUMS256.txt | sha256sum -c -)
          unzip -j "/tmp/${ZIPFILE}" "node-${NODE_VERSION}-${NODE_ARCH}/node.exe" -d "${DEST}/"
          "${DEST}/node.exe" --version
          rm -f "/tmp/${ZIPFILE}"

      - name: Build Tauri app (macOS)
        if: matrix.os == 'macos-latest'
        working-directory: app
        run: npx tauri build --bundles app

      - name: Build Tauri app (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: app
        run: npx tauri build --no-bundle

      - name: Package macOS release
        if: matrix.os == 'macos-latest'
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
        run: |
          STAGE="MigrationUtility-v${VERSION}-macos"
          mkdir -p "$STAGE"
          cp -R "app/src-tauri/target/release/bundle/macos/Migration Utility.app" "$STAGE/"
          cat > "$STAGE/run.sh" << 'SCRIPT'
          #!/bin/bash
          DIR="$(cd "$(dirname "$0")" && pwd)"
          xattr -cr "$DIR/Migration Utility.app"
          open -n "$DIR/Migration Utility.app"
          SCRIPT
          chmod +x "$STAGE/run.sh"
          zip -r "${STAGE}.zip" "$STAGE"

      - name: Package Windows release
        if: matrix.os == 'windows-latest'
        shell: bash
        env:
          VERSION: ${{ inputs.version }}
        run: |
          STAGE="MigrationUtility-v${VERSION}-windows"
          mkdir -p "$STAGE"
          cp "app/src-tauri/target/release/migration-utility.exe" "$STAGE/"

          # Copy sidecar JS files
          mkdir -p "$STAGE/sidecar/dist/sdk"
          cp "app/sidecar/dist/package.json" "$STAGE/sidecar/dist/"
          cp "app/sidecar/dist/bootstrap.js" "$STAGE/sidecar/dist/" 2>/dev/null || true
          cp "app/sidecar/dist/agent-runner.js" "$STAGE/sidecar/dist/"
          cp "app/sidecar/dist/sdk/cli.js" "$STAGE/sidecar/dist/sdk/" 2>/dev/null || true
          cp "app/sidecar/dist/sdk/manifest.json" "$STAGE/sidecar/dist/sdk/" 2>/dev/null || true
          cp app/sidecar/dist/sdk/*.wasm "$STAGE/sidecar/dist/sdk/" 2>/dev/null || true

          # Copy bundled Node.js binary
          if [ -d "app/src-tauri/resources/node" ]; then
            mkdir -p "$STAGE/resources"
            cp -r "app/src-tauri/resources/node" "$STAGE/resources/node"
          fi

          7z a "${STAGE}.zip" "$STAGE"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-name }}
          path: MigrationUtility-v*.zip

  release:
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate release notes
        id: notes
        shell: bash
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RELEASE_VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail

          PREVIOUS_TAG=$(git tag --sort=-creatordate | grep '^v' | head -2 | tail -1)

          if [ -z "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --oneline --format="%s" HEAD)
          else
            COMMITS=$(git log --oneline --format="%s" "${PREVIOUS_TAG}..HEAD")
          fi

          if [ -z "$COMMITS" ]; then
            COMMITS="No commits found for this release."
          fi

          FALLBACK=$(echo "$COMMITS" | sed 's/^/- /')
          NOTES=""

          if [ -n "${ANTHROPIC_API_KEY:-}" ]; then
            export COMMITS
            PAYLOAD=$(jq -n '{
              model: "claude-haiku-4-5-20251001",
              max_tokens: 1024,
              messages: [{
                role: "user",
                content: ("You are writing release notes for Migration Utility v" + env.RELEASE_VERSION + ", a desktop app that migrates Microsoft Fabric Warehouse stored procedures to dbt models.\n\nSummarize the git commits below into polished, user-facing release notes.\n\nFormat:\n1. Start with 1-2 sentences highlighting the most notable change(s)\n2. Then group changes under these markdown headings (omit any with no items):\n   ### Highlights\n   ### New\n   ### Improved\n   ### Fixed\n\nOnly add a ### Breaking Changes section if there are changes that require user action.\n\nWriting style:\n- Write for end users (Field Data Engineers), not developers\n- Keep each bullet to one concise sentence\n- Describe what changed from the user perspective, not the code perspective\n- No commit hashes, file paths, PR numbers, or technical jargon\n- If multiple commits relate to the same user-facing change, combine them into one bullet\n\nCommits:\n" + env.COMMITS)
              }]
            }')

            RESPONSE=$(curl -s --max-time 60 \
              -H "x-api-key: ${ANTHROPIC_API_KEY}" \
              -H "anthropic-version: 2023-06-01" \
              -H "content-type: application/json" \
              -d "$PAYLOAD" \
              "https://api.anthropic.com/v1/messages" 2>/dev/null) || true

            if [ -n "${RESPONSE:-}" ]; then
              NOTES=$(echo "$RESPONSE" | jq -r '.content[0].text // empty' 2>/dev/null) || true
            fi
          fi

          if [ -z "${NOTES:-}" ]; then
            NOTES=$(printf "### What's Changed\n\n%s" "$FALLBACK")
          fi

          echo "release_notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: Migration Utility v${{ github.event.inputs.version }}
          body: ${{ steps.notes.outputs.release_notes }}
          files: artifacts/**/*.zip
